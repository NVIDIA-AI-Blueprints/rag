{
  "title": "RAG Metrics",
  "uid": "rag-metrics",
  "version": 5,
  "schemaVersion": 40,
  "editable": false,
  "time": { "from": "now-5m", "to": "now" },
  "timezone": "browser",
  "refresh": "30s",
  "panels": [
    { "type": "row", "title": "Latency overview (avg over $__rate_interval)", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }, "collapsed": false, "panels": [] },

    {
      "type": "stat",
      "title": "Avg LLM TTFT (ms)",
      "description": "Average LLM time-to-first-token over $__rate_interval",
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
      "targets": [ {
        "refId": "A",
        "expr": "sum(increase(llm_ttft_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(llm_ttft_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))"
      } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "auto" }
    },

    {
      "type": "stat",
      "title": "Avg RAG TTFT (ms)",
      "description": "Average RAG time-to-first-token over $__rate_interval",
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
      "targets": [ {
        "refId": "A",
        "expr": "sum(increase(rag_ttft_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(rag_ttft_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))"
      } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "auto" }
    },

    {
      "type": "stat",
      "title": "Avg Retrieval Time (ms)",
      "description": "Average retrieval time over $__rate_interval",
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum(increase(retrieval_time_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(retrieval_time_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "auto" }
    },

    {
      "type": "stat",
      "title": "Avg Context Reranker (ms)",
      "description": "Average context reranker time over $__rate_interval",
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum(increase(context_reranker_time_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(context_reranker_time_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "auto" }
    },

    {
      "type": "stat",
      "title": "Avg Total Time (ms)",
      "description": "Average end-to-end time over $__rate_interval",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
              "targets": [ { "refId": "A", "expr": "sum(increase(llm_generation_time_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(llm_generation_time_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "auto" }
    },

    { "type": "row", "title": "Latency averages over time ($__rate_interval windows)", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 }, "collapsed": false, "panels": [] },

    {
      "type": "timeseries",
      "title": "LLM TTFT avg (ms)",
      "description": "Average LLM TTFT over $__rate_interval",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "avg", "expr": "sum(increase(llm_ttft_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(llm_ttft_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "avg" } ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },

    {
      "type": "timeseries",
      "title": "Total time avg (ms)",
      "description": "Average end-to-end time over $__rate_interval",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "ms", "decimals": 2 }, "overrides": [] },
        "targets": [ { "refId": "avg", "expr": "sum(increase(llm_generation_time_ms_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(llm_generation_time_ms_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "avg" } ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },

    { "type": "row", "title": "Requests", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 }, "collapsed": false, "panels": [] },

    {
      "type": "stat",
      "title": "Reqs/sec (overall)",
      "description": "Overall request throughput over $__rate_interval",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 15 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum(rate(api_requests_total{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } }
    },

    {
      "type": "timeseries",
      "title": "Reqs/sec by endpoint",
      "description": "Request throughput by endpoint over $__rate_interval",
      "gridPos": { "h": 8, "w": 9, "x": 6, "y": 15 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum by (endpoint) (rate(api_requests_total{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "{{endpoint}}" } ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },

    {
      "type": "timeseries",
      "title": "Reqs/sec by method",
      "description": "Request throughput by method over $__rate_interval",
      "gridPos": { "h": 8, "w": 9, "x": 15, "y": 15 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum by (method) (rate(api_requests_total{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "{{method}}" } ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },

    { "type": "row", "title": "Tokens & context", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 }, "collapsed": false, "panels": [] },

    {
      "type": "stat",
      "title": "Avg total tokens per request (over $__rate_interval)",
      "description": "Average total tokens per request based on token_usage_distribution histogram over $__rate_interval",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 24 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum(increase(token_usage_distribution_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(token_usage_distribution_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } }
    },

    {
      "type": "stat",
      "title": "Last input tokens ($__rate_interval)",
      "description": "Last observed input tokens over $__rate_interval",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 24 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "last_over_time(input_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } }
    },

    {
      "type": "stat",
      "title": "Last output tokens ($__rate_interval)",
      "description": "Last observed output tokens over $__rate_interval",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 24 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "last_over_time(output_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } }
    },

    {
      "type": "stat",
      "title": "Last total tokens ($__rate_interval)",
      "description": "Last observed total tokens over $__rate_interval",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 24 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "last_over_time(total_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])" } ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } }
    },

    {
      "type": "timeseries",
      "title": "Total tokens per request (avg, $__rate_interval)",
      "description": "Average total tokens per request over $__rate_interval",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 28 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 2 }, "overrides": [] },
      "targets": [ { "refId": "A", "expr": "sum(increase(token_usage_distribution_sum{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])) / sum(increase(token_usage_distribution_count{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "avg total tokens" } ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },

    {
      "type": "timeseries",
      "title": "Tokens (gauge, last)",
      "description": "Last observed token gauges over $__rate_interval",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 28 },
      "datasource": "$datasource",
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "targets": [
        { "refId": "in", "expr": "last_over_time(input_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])", "legendFormat": "input (last)" },
        { "refId": "out", "expr": "last_over_time(output_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])", "legendFormat": "output (last)" },
        { "refId": "tot", "expr": "last_over_time(total_tokens{job=~\"$job\", instance=~\"$instance\"}[$__rate_interval])", "legendFormat": "total (last)" }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    }
  ],

  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "label": "Data source",
        "query": "prometheus",
        "refresh": 1,
        "current": { "text": "Prometheus", "value": "Prometheus" },
        "options": []
      },
      {
        "name": "job",
        "type": "query",
        "label": "Job",
        "datasource": "$datasource",
        "refresh": 2,
        "hide": 0,
        "includeAll": true,
        "allValue": ".+",
        "multi": true,
        "definition": "label_values(up, job)",
        "query": { "query": "label_values(up, job)", "refId": "StandardVariableQuery" }
      },
      {
        "name": "instance",
        "type": "query",
        "label": "Instance",
        "datasource": "$datasource",
        "refresh": 2,
        "hide": 0,
        "includeAll": true,
        "allValue": ".+",
        "multi": true,
        "definition": "label_values(up{job=~\"$job\"}, instance)",
        "query": { "query": "label_values(up{job=~\"$job\"}, instance)", "refId": "StandardVariableQuery" }
      }
    ]
  },

  "annotations": { "list": [] },
  "links": []
}